name: Force Update Fork

on:
  push:
    branches:
      - master
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # 每天自动更新

jobs:
  nuclear-update:
    runs-on: ubuntu-latest
    steps:
      # 1. 设置环境变量
      - name: Set up environment
        run: |
          echo "GH_USER=ddkwork" >> $GITHUB_ENV
          echo "PATCH_FILE=dropFile.patch" >> $GITHUB_ENV
          echo "UPSTREAM_URL=https://github.com/gioui/gio" >> $GITHUB_ENV
          echo "FORK_URL=https://github.com/${{ env.GH_USER }}/gio" >> $GITHUB_ENV  # 修复变量名

      # 2. 克隆上游仓库
      - name: Clone upstream
        run: |
          git clone --depth=1 $UPSTREAM_URL gio
          cd gio
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
        shell: bash

      # 3. 检出当前仓库获取补丁文件
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          path: current-repo

      # 4. 简化 GitHub CLI 认证（无需登录步骤）
      - name: Setup GitHub CLI
        run: |
          # 直接设置GH_TOKEN环境变量
          gh auth status || true  # 忽略未登录的错误
          echo "GH_TOKEN=${{ secrets.tk }}" >> $GITHUB_ENV
        shell: bash

      # 5. 应用补丁并推送
      - name: Apply patch and push
        run: |
          echo "应用补丁 $PATCH_FILE..."
          cd gio
          
          # 复制补丁文件
          cp ../current-repo/$PATCH_FILE .
          
          # 应用补丁
          git apply $PATCH_FILE
          
          # 添加并提交更改
          git add .
          git commit -m "暴力更新 $(date +'%Y-%m-%d %H:%M')"
          
          # 设置远程地址 (使用HTTPS)
          git remote set-url origin $FORK_URL
          
          # 使用环境变量中的GH_TOKEN进行推送
          echo "强制推送到 $FORK_URL..."
          git push --force "https://$GH_USER:$GH_TOKEN@github.com/$GH_USER/gio.git" main
          
          # 清理
          rm $PATCH_FILE
          echo "更新完成!"
        shell: bash
        env:
          GH_USER: ${{ env.GH_USER }}
          GH_TOKEN: ${{ env.GH_TOKEN }}
          PATCH_FILE: ${{ env.PATCH_FILE }}