name: Force Update Fork

on:
  push:
    branches:
      - master
  workflow_dispatch:  # 手动触发按钮
  schedule:
    - cron: '0 0 * * *'  # 每天自动更新



jobs:
  nuclear-update:
    runs-on: ubuntu-latest
    steps:
      # 1. 设置环境
      - name: Set up environment
        run: |
          GH_USER="ddkwork"  # 替换为你的 GitHub 用户名
          FORK_REPO="github.com/$GH_USER/gio"
          PATCH_FILE="dropFile.patch"

      # 2. 克隆官方最新 main 分支
      - name: Clone upstream
        run: git clone --depth=1 https://github.com/gioui/gio
        shell: bash

      # 3. 准备补丁文件 (从仓库内获取)
      - name: Fetch patch file
        uses: actions/checkout@v4
        with:
          path: patch-source
          fetch-depth: 0

      # 4. 应用你的暴力流程
      - name: Execute nuclear script
        run: |
          cd gio
          
          # 修改远程地址
          git remote set-url origin git@github.com:$GH_USER/gio.git
          
          # 复制补丁
          cp ../$PATCH_FILE .
          
          # 应用补丁
          git apply $PATCH_FILE
          
          # 提交更改
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          git commit -am "暴力更新 $(date +'%Y-%m-%d')"
          
          # 强制推送
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git push --force origin main
          
          # 清理
          rm $PATCH_FILE
        shell: bash
        env:
          GH_USER: ${{ github.repository_owner }}

      # 5. 使用你的 SSH Key 进行认证 (可选但推荐)
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.tk }}
