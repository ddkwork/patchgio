From b471301ca236eca75dcdb22c7543ab7ac23b570c Mon Sep 17 00:00:00 2001
From: ddkwork <2762713521@qq.com>
Date: Wed, 11 Feb 2026 09:10:48 +0800
Subject: [PATCH] feat: 添加Windows文件拖放功能
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 8bit

---
 app/filedrop.go                 |  7 ++++++
 app/internal/windows/windows.go | 44 +++++++++++++++++++++++++++++++++
 app/os_windows.go               | 30 +++++++++++++++++++++-
 3 files changed, 80 insertions(+), 1 deletion(-)
 create mode 100644 app/filedrop.go

diff --git a/app/filedrop.go b/app/filedrop.go
new file mode 100644
index 00000000..75f10ab8
--- /dev/null
+++ b/app/filedrop.go
@@ -0,0 +1,7 @@
+package app
+
+var fileDropCallback = func(files []string) {}
+
+func FileDropCallback(fn func(files []string)) {
+	fileDropCallback = fn
+}
diff --git a/app/internal/windows/windows.go b/app/internal/windows/windows.go
index ecac9222..41ac6323 100644
--- a/app/internal/windows/windows.go
+++ b/app/internal/windows/windows.go
@@ -182,6 +182,9 @@ type PointerInfo struct {
 }
 
 const (
+	WM_DROPFILES      = 0x233
+	WS_EX_ACCEPTFILES = 0x00000010
+
 	TRUE = 1
 
 	CPS_CANCEL = 0x0004
@@ -492,6 +495,47 @@ var (
 
 	dwmapi                        = syscall.NewLazySystemDLL("dwmapi")
 	_DwmExtendFrameIntoClientArea = dwmapi.NewProc("DwmExtendFrameIntoClientArea")
+
+	shell32         = syscall.NewLazySystemDLL("shell32")
+	_DragQueryFileW = shell32.NewProc("DragQueryFileW")
+	_DragQueryPoint = shell32.NewProc("DragQueryPoint")
+	_DragFinish     = shell32.NewProc("DragFinish")
+)
+
+func DragQueryFile(hDrop HDROP, iFile uint) (fileName string, fileCount uint) {
+	ret, _, _ := _DragQueryFileW.Call(hDrop, uintptr(iFile), 0, 0)
+	fileCount = uint(ret)
+	if iFile != 0xFFFFFFFF {
+		buf := make([]uint16, fileCount+1)
+		ret, _, _ := _DragQueryFileW.Call(
+			hDrop,
+			uintptr(iFile),
+			uintptr(unsafe.Pointer(&buf[0])),
+			uintptr(fileCount+1))
+
+		if ret == 0 {
+			panic("Invoke DragQueryFile error.")
+		}
+		fileName = syscall.UTF16ToString(buf)
+	}
+	return
+}
+
+func DragQueryPoint(hDrop HDROP) (x, y int, isClientArea bool) {
+	var pt Point
+	ret, _, _ := _DragQueryPoint.Call(
+		hDrop,
+		uintptr(unsafe.Pointer(&pt)))
+	return int(pt.X), int(pt.Y), ret == 1
+}
+
+func DragFinish(hDrop HDROP) {
+	_DragFinish.Call(hDrop)
+}
+
+type (
+	HANDLE = uintptr
+	HDROP  = HANDLE
 )
 
 func AdjustWindowRectEx(r *Rect, dwStyle uint32, bMenu int, dwExStyle uint32) {
diff --git a/app/os_windows.go b/app/os_windows.go
index f36e64a3..b2b3b353 100644
--- a/app/os_windows.go
+++ b/app/os_windows.go
@@ -159,7 +159,7 @@ func initResources() error {
 	return nil
 }
 
-const dwExStyle = windows.WS_EX_APPWINDOW | windows.WS_EX_WINDOWEDGE
+const dwExStyle = windows.WS_EX_APPWINDOW | windows.WS_EX_WINDOWEDGE | windows.WS_EX_ACCEPTFILES
 
 func (w *window) init() error {
 	var resErr error
@@ -197,9 +197,15 @@ func (w *window) init() error {
 		return err
 	}
 	w.hwnd = hwnd
+	setCaptionColor(syscall.HWND(hwnd), 0x292929)
 	return nil
 }
 
+func setCaptionColor(handle syscall.HWND, color uint32) {
+	const DWMWA_CAPTION_COLOR = 35
+	syscall.DwmSetWindowAttribute(handle, DWMWA_CAPTION_COLOR, unsafe.Pointer(&color), uint32(unsafe.Sizeof(color)))
+}
+
 // update handles changes done by the user, and updates the configuration.
 // It reads the window style and size/position and updates w.config.
 // If anything has changed it emits a ConfigEvent to notify the application.
@@ -235,6 +241,26 @@ func (w *window) update() {
 	w.draw(true)
 }
 
+type dropFilesResult struct {
+	X, Y  int
+	Files []string
+}
+
+func dragQueryFile(hDrop uintptr) dropFilesResult {
+	var data dropFilesResult
+	_, fileCount := windows.DragQueryFile(hDrop, 0xFFFFFFFF)
+	data.Files = make([]string, fileCount)
+
+	var i uint
+	for i = range fileCount {
+		data.Files[i], _ = windows.DragQueryFile(hDrop, i)
+	}
+
+	data.X, data.Y, _ = windows.DragQueryPoint(hDrop)
+	windows.DragFinish(hDrop)
+	return data
+}
+
 func windowProc(hwnd syscall.Handle, msg uint32, wParam, lParam uintptr) uintptr {
 	win, exists := winMap.Load(hwnd)
 	if !exists {
@@ -244,6 +270,8 @@ func windowProc(hwnd syscall.Handle, msg uint32, wParam, lParam uintptr) uintptr
 	w := win.(*window)
 
 	switch msg {
+	case windows.WM_DROPFILES:
+		fileDropCallback(dragQueryFile(wParam).Files)
 	case windows.WM_UNICHAR:
 		if wParam == windows.UNICODE_NOCHAR {
 			// Tell the system that we accept WM_UNICHAR messages.
-- 
2.47.0.windows.2

