From 36c8b31dc25cee8afa698a6f0456ed923f98ad6a Mon Sep 17 00:00:00 2001
From: ddkwork <2762713521@qq.com>
Date: Fri, 13 Feb 2026 08:58:00 +0800
Subject: [PATCH] 0004-fix- 修复坐标转换和菜单溢出问题_gio核心
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 8bit

---
 io/input/pointer.go   | 13 +++++++++++++
 io/pointer/pointer.go |  8 ++++++++
 2 files changed, 21 insertions(+)

diff --git a/io/input/pointer.go b/io/input/pointer.go
index c3e399f8..777b3d4e 100644
--- a/io/input/pointer.go
+++ b/io/input/pointer.go
@@ -582,6 +582,15 @@ func (q *pointerQueue) invTransform(areaIdx int, p f32.Point) f32.Point {
 	return q.areas[areaIdx].trans.Invert().Transform(p)
 }
 
+// getTransform returns the accumulated transform for the specified area.
+// The areas[areaIdx].trans is already the accumulated global transform.
+func (q *pointerQueue) getTransform(areaIdx int) f32.Affine2D {
+	if areaIdx == -1 {
+		return f32.AffineId()
+	}
+	return q.areas[areaIdx].trans
+}
+
 func (q *pointerQueue) hit(areaIdx int, p f32.Point) (bool, pointer.Cursor) {
 	c := pointer.CursorDefault
 	for areaIdx != -1 {
@@ -705,6 +714,7 @@ func (q *pointerQueue) Deliver(handlers map[event.Tag]*handler, areaIdx int, e p
 			}
 			scroll, e.Scroll = h.filter.pointer.clampScroll(scroll)
 		}
+		e.Transform = q.getTransform(h.pointer.areaPlusOne - 1)
 		e.Position = q.invTransform(h.pointer.areaPlusOne-1, e.Position)
 		evts = append(evts, taggedEvent{tag: n.tag, event: e})
 		if e.Kind != pointer.Scroll {
@@ -801,6 +811,7 @@ func (q *pointerQueue) deliverEvent(handlers map[event.Tag]*handler, p pointerIn
 			scroll, e.Scroll = f.clampScroll(scroll)
 		}
 		e := e
+		e.Transform = q.getTransform(h.pointer.areaPlusOne - 1)
 		e.Position = q.invTransform(h.pointer.areaPlusOne-1, e.Position)
 		evts = append(evts, taggedEvent{event: e, tag: k})
 	}
@@ -860,6 +871,7 @@ func (q *pointerQueue) deliverEnterLeaveEvents(handlers map[event.Tag]*handler,
 		e.Kind = pointer.Leave
 
 		if h.filter.pointer.Matches(e) {
+			e.Transform = q.getTransform(h.pointer.areaPlusOne - 1)
 			e.Position = q.invTransform(h.pointer.areaPlusOne-1, e.Position)
 			evts = append(evts, taggedEvent{tag: k, event: e})
 		}
@@ -878,6 +890,7 @@ func (q *pointerQueue) deliverEnterLeaveEvents(handlers map[event.Tag]*handler,
 		e.Kind = pointer.Enter
 
 		if h.filter.pointer.Matches(e) {
+			e.Transform = q.getTransform(h.pointer.areaPlusOne - 1)
 			e.Position = q.invTransform(h.pointer.areaPlusOne-1, e.Position)
 			evts = append(evts, taggedEvent{tag: k, event: e})
 		}
diff --git a/io/pointer/pointer.go b/io/pointer/pointer.go
index a65f840c..94fe761f 100644
--- a/io/pointer/pointer.go
+++ b/io/pointer/pointer.go
@@ -39,6 +39,14 @@ type Event struct {
 	// Modifiers is the set of active modifiers when
 	// the mouse button was pressed.
 	Modifiers key.Modifiers
+	// Transform is the transformation matrix that converts from local
+	// coordinates to window (global) coordinates.
+	Transform f32.Affine2D
+}
+
+// AbsolutePosition returns the event position in window coordinates.
+func (e Event) AbsolutePosition() f32.Point {
+	return e.Transform.Transform(e.Position)
 }
 
 // PassOp sets the pass-through mode. InputOps added while the pass-through
-- 
2.47.0.windows.2

